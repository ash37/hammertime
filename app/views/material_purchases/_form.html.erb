<% admin_view = current_user&.owner? || current_user&.admin? %>
<%= form_with model: material_purchase,
  class: "space-y-6",
  data: { controller: "material-totals job-markup", job_markup_auto_value: material_purchase.new_record? } do |form| %>
  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <%= form.label :job_id, "Job", class: "text-sm font-medium text-slate-700" %>
      <%= form.select :job_id,
        [],
        {},
        class: "mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm",
        data: { action: "change->job-markup#update", job_markup_target: "jobSelect" } do %>
        <option value="">Select job</option>
        <% @jobs.each do |job| %>
          <option value="<%= job.id %>" data-default-markup="<%= job.default_material_markup_percent %>" <%= "selected" if job.id == material_purchase.job_id %>><%= job.title %></option>
        <% end %>
      <% end %>
    </div>
    <% if admin_view %>
      <div>
        <%= form.label :purchased_on, "Purchased on", class: "text-sm font-medium text-slate-700" %>
        <%= form.date_field :purchased_on, class: "mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" %>
      </div>
    <% else %>
      <%= form.hidden_field :purchased_on, value: material_purchase.purchased_on || Date.current %>
    <% end %>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div>
      <%= form.label :supplier_name, "Supplier", class: "text-sm font-medium text-slate-700" %>
      <%= form.text_field :supplier_name, class: "mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" %>
    </div>
    <div>
      <%= form.label :description, class: "text-sm font-medium text-slate-700" %>
      <%= form.text_field :description, class: "mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" %>
    </div>
  </div>

  <div class="grid gap-6 md:grid-cols-3">
    <% if admin_view %>
      <div>
        <%= form.label :quantity, class: "text-sm font-medium text-slate-700" %>
        <%= form.number_field :quantity, step: 0.01, min: 0, class: "mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm", data: { action: "input->material-totals#update", material_totals_target: "quantity" } %>
      </div>
    <% else %>
      <% quantity_value = material_purchase.quantity.to_f > 0 ? material_purchase.quantity : 1 %>
      <%= form.hidden_field :quantity, value: quantity_value, data: { material_totals_target: "quantity" } %>
    <% end %>
    <div>
      <label class="text-sm font-medium text-slate-700"><%= admin_view ? "Unit cost" : "Cost" %></label>
      <div class="mt-2 flex items-center gap-2">
        <span class="text-sm text-slate-400">$</span>
        <%= number_field_tag "material_purchase[unit_cost_dollars]", @unit_cost_dollars, step: 0.01, min: 0, class: "w-full rounded-xl border border-slate-200 px-3 py-2 text-sm", data: { action: "input->material-totals#update", material_totals_target: "unitCost" } %>
      </div>
    </div>
    <% if admin_view %>
      <div>
        <%= form.label :markup_percent, "Markup %", class: "text-sm font-medium text-slate-700" %>
        <%= form.number_field :markup_percent, step: 0.01, min: 0, class: "mt-2 w-full rounded-xl border border-slate-200 px-3 py-2 text-sm", data: { action: "input->material-totals#update", material_totals_target: "markup", job_markup_target: "markup" } %>
      </div>
    <% else %>
      <%= form.hidden_field :markup_percent, value: material_purchase.markup_percent.presence || material_purchase.job&.default_material_markup_percent, data: { material_totals_target: "markup", job_markup_target: "markup" } %>
    <% end %>
  </div>

  <% if admin_view %>
    <div class="rounded-xl border border-slate-100 bg-slate-50 p-4 text-sm text-slate-600">
      <div class="flex items-center justify-between">
        <span>Sell unit price</span>
        <span class="font-semibold" data-material-totals-target="sellUnit"><%= number_to_currency(material_purchase.sell_unit_price_cents / 100.0) %></span>
      </div>
      <div class="mt-2 flex items-center justify-between">
        <span>Total sell</span>
        <span class="font-semibold" data-material-totals-target="total"><%= number_to_currency(material_purchase.total_sell_cents / 100.0) %></span>
      </div>
    </div>
  <% end %>

  <div class="flex items-center gap-3">
    <%= form.submit class: "rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" %>
    <%= link_to "Cancel", material_purchases_path, class: "text-sm text-slate-500 hover:text-slate-700" %>
  </div>
<% end %>

<% content_for :page_title, "Dashboard" %>

<% staff_view = current_user&.staff? %>
<div class="space-y-8">
  <% if staff_view %>
    <div class="grid gap-4 md:grid-cols-2">
     
       <%= link_to new_material_purchase_path, class: "flex items-center justify-center rounded-full bg-lime-900 px-6 py-10 text-xl font-semibold text-lime-400 transition hover:bg-lime-950" do %>
        <span class="mr-4 inline-flex h-10 w-10 items-center justify-center rounded-full bg-lime-800">
          <%= heroicon_tag "wrench-screwdriver", variant: :outline, size: 20, class: "h-6 w-6 text-lime-400" %>
        </span>
      Add Purchase
      <% end %>
      <%= link_to new_timesheet_entry_path, class: "flex items-center justify-center rounded-full bg-lime-900 px-6 py-10 text-xl font-semibold text-lime-400 transition hover:bg-lime-950" do %>
        <span class="mr-4 inline-flex h-10 w-10 items-center justify-center rounded-full bg-lime-800">
          <%= heroicon_tag "clock", variant: :outline, size: 20, class: "h-6 w-6 text-lime-400" %>
        </span>
        Add Timesheet
      <% end %>
    </div>
  <% else %>
  <div class="grid gap-6 lg:grid-cols-4">
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Today's hours</p>
      <p class="mt-3 text-2xl font-semibold text-slate-900"><%= (@today_minutes.to_f / 60).round(2) %>h</p>
      <p class="mt-2 text-xs text-slate-500">Logged across active jobs</p>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Unbilled labour</p>
      <p class="mt-3 text-2xl font-semibold text-slate-900"><%= number_to_currency(@unbilled_labour_cents / 100.0) %></p>
      <p class="mt-2 text-xs text-slate-500">Ready to invoice</p>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Unbilled materials</p>
      <p class="mt-3 text-2xl font-semibold text-slate-900"><%= number_to_currency(@unbilled_materials_cents / 100.0) %></p>
      <p class="mt-2 text-xs text-slate-500">Including markup</p>
    </div>
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Draft invoices</p>
      <p class="mt-3 text-2xl font-semibold text-slate-900"><%= @draft_invoices_count %></p>
      <p class="mt-2 text-xs text-slate-500">Awaiting review</p>
    </div>
  </div>

  <div class="grid gap-6 lg:grid-cols-2">
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <p class="text-sm font-semibold text-slate-900">
            <%= @timesheets_view == "recent" ? "Recent timesheets" : "Timesheets" %>
          </p>
          <% if @timesheets_view == "recent" %>
            <%= link_to "View needing action",
              url_for(request.query_parameters.merge(timesheets_view: "action", timesheets_page: 1)),
              class: "text-xs font-semibold text-slate-500 hover:text-slate-700" %>
          <% else %>
            <%= link_to "View all",
              url_for(request.query_parameters.merge(timesheets_view: "recent", timesheets_page: 1)),
              class: "text-xs font-semibold text-slate-500 hover:text-slate-700" %>
          <% end %>
        </div>
        <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">
          <%= @timesheets_view == "recent" ? "Recent" : "Needs action" %>
        </span>
      </div>
      <div class="mt-4 overflow-hidden rounded-xl border border-slate-100">
        <table class="min-w-full divide-y divide-slate-100 text-sm">
          
          <tbody class="divide-y divide-slate-100 text-slate-600">
            <% @recent_timesheets.each do |entry| %>
              <tr>
                <td class="px-4 py-3">
                  <div class="text-sm font-semibold text-slate-900"><%= entry.work_date.strftime("%d") %></div>
                  <div class="text-xs uppercase tracking-wide text-slate-400"><%= entry.work_date.strftime("%b") %></div>
                </td>
                <td class="px-4 py-3">
                  <div class="font-semibold text-slate-900"><%= entry.job&.title || "Unassigned" %></div>
                  <div class="text-xs text-slate-500"><%= entry.user.display_name %></div>
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="font-semibold text-slate-900"><%= entry.hours.round(2) %>h</div>
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="font-semibold text-slate-900"><%= number_to_currency(entry.total_cents / 100.0) %></div>
                  <div class="mt-1">
                    <% if entry.draft? %>
                      <span class="rounded-full bg-rose-100 px-2 py-1 text-xs font-semibold text-rose-700">Draft</span>
                    <% elsif entry.billed? %>
                      <span class="rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">Billed</span>
                    <% else %>
                      <span class="rounded-full bg-orange-100 px-2 py-1 text-xs font-semibold text-orange-500">Unbilled</span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            <% if @recent_timesheets.empty? %>
              <tr>
                <td class="px-4 py-6 text-center text-sm text-slate-500" colspan="4">
                  <div class="relative overflow-hidden rounded-xl border border-slate-100 bg-white px-6 py-8">
                    <div class="pointer-events-none absolute inset-0">
                     


                      <span class="absolute left-4 top-3 h-3 w-3 rounded-full bg-orange-200"></span>
                      <span class="absolute right-8 top-6 h-2.5 w-2.5 rounded-full bg-emerald-200"></span>
                      <span class="absolute left-1/3 bottom-2 h-2 w-2 rounded-full bg-pink-200"></span>
                      <span class="absolute right-1/4 top-12 h-3 w-3 rounded-full bg-rose-200"></span>
                      <span class="absolute left-10 bottom-6 h-2.5 w-2.5 rounded-full bg-indigo-200"></span>
                      <span class="absolute right-6 bottom-4 h-2 w-2 rounded-full bg-sky-200"></span>
                      <span class="absolute left-1/2 top-2 h-3 w-3 rounded-full bg-teal-200"></span>



                    </div>
                    <span class="relative font-semibold text-slate-500">
                      <%= @timesheets_view == "recent" ? "No timesheets yet." : "No timesheets needing action." %>
                    </span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <% if @recent_timesheets.any? %>
        <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
          <% if @timesheets_has_prev %>
            <%= link_to "Previous", url_for(request.query_parameters.merge(timesheets_page: @timesheets_page - 1)), class: "font-semibold text-slate-600 hover:text-slate-900" %>
          <% else %>
            <span class="text-slate-300">Previous</span>
          <% end %>
          <span>Page <%= @timesheets_page %></span>
          <% if @timesheets_has_next %>
            <%= link_to "Next", url_for(request.query_parameters.merge(timesheets_page: @timesheets_page + 1)), class: "font-semibold text-slate-600 hover:text-slate-900" %>
          <% else %>
            <span class="text-slate-300">Next</span>
          <% end %>
        </div>
      <% end %>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-2">
          <p class="text-sm font-semibold text-slate-900">
            <%= @materials_view == "recent" ? "Recent materials" : "Materials" %>
          </p>
          <% if @materials_view == "recent" %>
            <%= link_to "View needing action",
              url_for(request.query_parameters.merge(materials_view: "action", materials_page: 1)),
              class: "text-xs font-semibold text-slate-500 hover:text-slate-700" %>
          <% else %>
            <%= link_to "View all",
              url_for(request.query_parameters.merge(materials_view: "recent", materials_page: 1)),
              class: "text-xs font-semibold text-slate-500 hover:text-slate-700" %>
          <% end %>
        </div>
        <span class="rounded-full bg-slate-100 px-3 py-1 text-xs font-semibold text-slate-600">
          <%= @materials_view == "recent" ? "Recent" : "Needs action" %>
        </span>
      </div>
      <div class="mt-4 overflow-hidden rounded-xl border border-slate-100">
        <table class="min-w-full divide-y divide-slate-100 text-sm">
          
          <tbody class="divide-y divide-slate-100 text-slate-600">
            <% @recent_materials.each do |purchase| %>
              <tr>
                <td class="px-4 py-3">
                  <div class="text-sm font-semibold text-slate-900"><%= purchase.purchased_on.strftime("%d") %></div>
                  <div class="text-xs uppercase tracking-wide text-slate-400"><%= purchase.purchased_on.strftime("%b") %></div>
                </td>
                <td class="px-4 py-3">
                  <div class="font-semibold text-slate-900"><%= purchase.description.presence || purchase.supplier_name %></div>
                  <div class="text-xs text-slate-500"><%= purchase.supplier_name %> â€¢ <%= purchase.job.title %></div>
                </td>
                <td class="px-4 py-3 text-right">
                  <div class="font-semibold text-slate-900"><%= number_to_currency(purchase.total_sell_cents / 100.0) %></div>
                  <div class="mt-1">
                    <% if purchase.billed? %>
                      <span class="rounded-full bg-emerald-100 px-2 py-1 text-xs font-semibold text-emerald-700">Billed</span>
                    <% else %>
                      <span class="rounded-full bg-orange-100 px-2 py-1 text-xs font-semibold text-orange-500">Unbilled</span>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
            <% if @recent_materials.empty? %>
              <tr>
                <td class="px-4 py-6 text-center text-sm text-slate-500" colspan="3">
                  <div class="relative overflow-hidden rounded-xl border border-slate-100 bg-white px-6 py-8">
                    <div class="pointer-events-none absolute inset-0">
                      <span class="absolute left-4 top-3 h-3 w-3 rounded-full bg-sky-200"></span>
                      <span class="absolute right-8 top-6 h-2.5 w-2.5 rounded-full bg-emerald-200"></span>
                      <span class="absolute left-1/3 top-2 h-2 w-2 rounded-full bg-amber-200"></span>
                      <span class="absolute right-1/4 top-12 h-3 w-3 rounded-full bg-rose-200"></span>
                      <span class="absolute left-10 bottom-6 h-2.5 w-2.5 rounded-full bg-indigo-200"></span>
                      <span class="absolute right-6 bottom-4 h-2 w-2 rounded-full bg-orange-200"></span>
                      <span class="absolute left-1/2 bottom-2 h-3 w-3 rounded-full bg-teal-200"></span>
                    </div>
                    <span class="relative font-semibold text-slate-500">
                      <%= @materials_view == "recent" ? "No materials yet." : "No materials needing action." %>
                    </span>
                  </div>
                </td>
              </tr>
            <% end %>
          </tbody>
        </table>
      </div>
      <% if @recent_materials.any? %>
        <div class="mt-4 flex items-center justify-between text-sm text-slate-500">
          <% if @materials_has_prev %>
            <%= link_to "Previous", url_for(request.query_parameters.merge(materials_page: @materials_page - 1)), class: "font-semibold text-slate-600 hover:text-slate-900" %>
          <% else %>
            <span class="text-slate-300">Previous</span>
          <% end %>
          <span>Page <%= @materials_page %></span>
          <% if @materials_has_next %>
            <%= link_to "Next", url_for(request.query_parameters.merge(materials_page: @materials_page + 1)), class: "font-semibold text-slate-600 hover:text-slate-900" %>
          <% else %>
            <span class="text-slate-300">Next</span>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
  <% end %>
</div>

<% content_for :page_title, @user.display_name %>

<div class="space-y-6">
  <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-center gap-3">
      <%= link_to "Edit", edit_user_path(@user), class: "rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50" %>
      <%= button_to "Invite user", invite_user_path(@user), method: :post, class: "rounded-xl border border-slate-200 px-4 py-2 text-sm font-semibold text-slate-700 hover:bg-slate-50" %>
      <% unless @user == current_user %>
        <%= button_to "Deactivate", deactivate_user_path(@user), method: :patch, class: "rounded-xl border border-rose-200 px-4 py-2 text-sm font-semibold text-rose-600 hover:bg-rose-50" %>
      <% end %>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex flex-wrap items-start justify-between gap-4">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">User</p>
        <h2 class="mt-2 text-xl font-semibold text-slate-900"><%= @user.display_name %></h2>
        <p class="mt-1 text-sm text-slate-500"><%= @user.email %></p>
        <p class="mt-1 text-sm text-slate-500"><%= @user.mobile.presence || "—" %></p>
      </div>
      <div class="text-right">
        <span class="rounded-full px-3 py-1 text-xs font-semibold <%= @user.deactivated_at ? "bg-rose-100 text-rose-700" : "bg-emerald-100 text-emerald-700" %>">
          <%= @user.deactivated_at ? "Inactive" : "Active" %>
        </span>
        <p class="mt-2 text-xs uppercase tracking-wide text-slate-400"><%= @user.role.titleize %></p>
      </div>
    </div>
  </div>

  <div class="grid gap-6 md:grid-cols-2">
    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <p class="text-sm font-semibold text-slate-900">Rates</p>
      <div class="mt-4 space-y-2 text-sm text-slate-600">
        <div class="flex items-center justify-between">
          <span>Default Billing Rate</span>
          <span class="font-semibold text-slate-900"><%= number_to_currency(@user.default_billing_rate_cents / 100.0) %></span>
        </div>
        <div class="flex items-center justify-between">
          <span>Hourly Cost</span>
          <span class="font-semibold text-slate-900"><%= number_to_currency(@user.hourly_cost_cents / 100.0) %></span>
        </div>
      </div>
    </div>

    <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
      <p class="text-sm font-semibold text-slate-900">Account</p>
      <p class="mt-4 text-sm text-slate-600"><%= @user.account.name %></p>
      <p class="mt-2 text-xs text-slate-500">Invited: <%= @user.invitation_sent_at ? l(@user.invitation_sent_at, format: :short) : "Not sent" %></p>
    </div>
  </div>

  <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-xs font-semibold uppercase tracking-wide text-slate-400">Roster template</p>
        <p class="mt-2 text-sm font-semibold text-slate-900"><%= (@user.first_name.presence || @user.display_name) %> Roster</p>
      </div>
    </div>

    <% time_options = time_picker_options(15) %>
    <% weekly_minutes = @roster_entries.sum(&:total_minutes) %>
    <%= form_with model: @user, url: roster_user_path(@user), method: :patch, class: "mt-4 space-y-4" do |form| %>
      <% roster_errors = @user.roster_entries.flat_map { |entry| entry.errors.full_messages } %>
      <% if roster_errors.any? %>
        <div class="rounded-xl border border-rose-200 bg-rose-50 px-4 py-3 text-sm text-rose-700">
          <p class="font-semibold">Please fix the following:</p>
          <ul class="mt-2 list-disc pl-5">
            <% roster_errors.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      <div class="overflow-hidden rounded-xl border border-slate-100">
        <table class="min-w-full divide-y divide-slate-100 text-sm">
          <thead class="bg-slate-50 text-xs uppercase tracking-wide text-slate-400">
            <tr>
              <th class="px-4 py-3 text-left">Day</th>
              <th class="px-4 py-3 text-left">Start</th>
              <th class="px-4 py-3 text-left">Finish</th>
              <th class="px-4 py-3 text-center">Break</th>
              <th class="px-4 py-3 text-right">Hours</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 text-slate-600">
            <% @roster_entries.each do |entry| %>
              <%= form.fields_for :roster_entries, entry do |roster_fields| %>
                <tr>
                  <td class="px-4 py-3 font-medium text-slate-900">
                    <%= Date::DAYNAMES[entry.day_of_week] %>
                    <%= roster_fields.hidden_field :day_of_week %>
                  </td>
                  <td class="px-4 py-3">
                    <%= roster_fields.select :start_time,
                      options_for_select(time_options, entry.start_time&.strftime("%H:%M")),
                      { include_blank: true },
                      class: "w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" %>
                  </td>
                  <td class="px-4 py-3">
                    <%= roster_fields.select :end_time,
                      options_for_select(time_options, entry.end_time&.strftime("%H:%M")),
                      { include_blank: true },
                      class: "w-full rounded-xl border border-slate-200 px-3 py-2 text-sm" %>
                  </td>
                  <td class="px-4 py-3 text-center">
                    <%= roster_fields.check_box :unpaid_break, class: "h-4 w-4 rounded border-slate-300 text-slate-900" %>
                  </td>
                  <td class="px-4 py-3 text-right font-semibold text-slate-900">
                    <% if entry.start_time.blank? || entry.end_time.blank? %>
                      <span class="text-slate-400">Day off</span>
                      <span class="text-slate-400">•</span>
                      <span class="text-slate-500">0h</span>
                    <% else %>
                      <%= entry.hours %>h
                    <% end %>
                  </td>
                </tr>
              <% end %>
            <% end %>
          </tbody>
          <tfoot class="bg-slate-50">
            <tr>
              <td class="px-4 py-3 text-sm font-semibold text-slate-700" colspan="4">Weekly hours</td>
              <td class="px-4 py-3 text-right text-sm font-semibold text-slate-900">
                <%= (weekly_minutes / 60.0).round(2) %>h
              </td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="flex items-center justify-end">
        <%= form.submit "Save roster", class: "rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white hover:bg-slate-800" %>
      </div>
    <% end %>
  </div>
</div>
